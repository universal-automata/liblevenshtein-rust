name: CI - Tests and Linting

on:
  push:
    branches: [ master, develop, dylon/* ]
  pull_request:
    branches: [ master, develop ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSTFLAGS: "-C target-cpu=native"

jobs:
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable, nightly]
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: aarch64-apple-darwin

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Checkout PathMap dependency
      run: |
        cd ../
        git clone --depth=1 --branch master https://github.com/F1R3FLY-io/PathMap.git PathMap

    - name: Install protobuf compiler (Linux)
      if: runner.os == 'Linux'
      run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

    - name: Install protobuf compiler (macOS)
      if: runner.os == 'macOS'
      run: brew install protobuf

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.rust }}
        components: rustfmt, clippy

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-${{ matrix.rust }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.rust }}-cargo-registry-

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-${{ matrix.rust }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.rust }}-cargo-index-

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-${{ matrix.rust }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.rust }}-cargo-build-target-

    - name: Build library
      run: |
        echo "::group::Building liblevenshtein"
        cargo build --all-features --verbose
        echo "::endgroup::"

    - name: Build CLI
      run: |
        echo "::group::Building CLI"
        cargo build --bin liblevenshtein --features cli,compression,protobuf --verbose
        echo "::endgroup::"

    - name: Run unit tests
      run: |
        echo "::group::Running unit tests"
        cargo test --lib --all-features --verbose
        echo "::endgroup::"

    - name: Run integration tests
      run: |
        echo "::group::Running integration tests"
        cargo test --test '*' --all-features --verbose -- --nocapture
        echo "::endgroup::"

    - name: Run doc tests
      run: |
        echo "::group::Running documentation tests"
        cargo test --doc --all-features --verbose
        echo "::endgroup::"

    - name: Build examples
      run: |
        echo "::group::Building examples"
        cargo build --examples --all-features --verbose
        echo "::endgroup::"

    - name: Upload test artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.rust }}
        path: |
          target/debug/
          tests/*.rs
          examples/*.rs
        retention-days: 7

  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Checkout PathMap dependency
      run: |
        cd ../
        git clone --depth=1 --branch master https://github.com/F1R3FLY-io/PathMap.git PathMap

    - name: Install protobuf compiler
      run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        components: rustfmt, clippy

    - name: Check formatting
      run: cargo fmt -- --check

    - name: Run clippy
      run: |
        # Lint workspace code with warnings-as-errors
        # --no-deps: Don't lint dependencies (avoids failing on upstream warnings)
        cargo clippy --all-features --no-deps -- -D warnings

  benchmarks:
    name: Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Checkout PathMap dependency
      run: |
        cd ../
        git clone --depth=1 --branch master https://github.com/F1R3FLY-io/PathMap.git PathMap

    - name: Install protobuf compiler
      run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: nightly
        components: rustfmt, clippy

    - name: Run benchmarks
      run: |
        echo "::group::Running benchmarks"
        cargo bench --all-features --no-fail-fast -- --output-format bencher | tee output.txt
        echo "::endgroup::"

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: output.txt
        retention-days: 30

  test-report:
    name: Test Report Summary
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: always()

    steps:
    - name: Generate summary
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.lint.result }}" == "success" ]; then
          echo "✅ All checks passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Some checks failed. Please review the logs." >> $GITHUB_STEP_SUMMARY
        fi
